!> @brief Implementation of ESMF Config utilities
!
!  This computer program is part of MOSSCO.
!> @copyright 2021-2022 Helmholtz-Zentrum Hereon
!> @copyright 2015-2021 Helmholtz-Zentrum Geesthacht
!> @author Carsten Lemmen <carsten.lemmen@hereon.de>
!
! MOSSCO is free software: you can redistribute it and/or modify it under the
! terms of the GNU General Public License v3+.  MOSSCO is distributed in the
! hope that it will be useful, but WITHOUT ANY WARRANTY.  Consult the file
! LICENSE.GPL or www.gnu.org/licenses/gpl-3.0.txt for the full license terms.
!

#define ESMF_CONTEXT  line=__LINE__,file=ESMF_FILENAME,method=ESMF_METHOD
#define ESMF_ERR_PASSTHRU msg="MOSSCO subroutine call returned error"
#undef ESMF_FILENAME
#define ESMF_FILENAME "mossco_config.F90"

#define _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(X) if (ESMF_LogFoundError(localrc, ESMF_ERR_PASSTHRU, ESMF_CONTEXT, rcToReturn=X)) call ESMF_Finalize(rc=localrc, endflag=ESMF_END_ABORT)

#ifndef VARLEN
#define VARLEN ESMF_MAXSTR
#endif

module mossco_config

use esmf
use mossco_strings
use mossco_memory

implicit none

private
public MOSSCO_ConfigGet

interface MOSSCO_ConfigGet
  module procedure MOSSCO_ConfigGetLogical
  module procedure MOSSCO_ConfigGetInt4
  module procedure MOSSCO_ConfigGetInt8
  module procedure MOSSCO_ConfigGetString
  module procedure MOSSCO_ConfigGetReal8
  module procedure MOSSCO_ConfigGetReal4
  module procedure MOSSCO_ConfigGetListInt4
  module procedure MOSSCO_ConfigGetListInt8
  module procedure MOSSCO_ConfigGetListReal4
  module procedure MOSSCO_ConfigGetListReal8
  module procedure MOSSCO_ConfigGetStringList
  module procedure MOSSCO_ConfigGetStringListPtr
  module procedure MOSSCO_ConfigGetStringTable
  module procedure MOSSCO_ConfigGetFileStringTable
end interface MOSSCO_ConfigGet

contains

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetLogical"
  subroutine MOSSCO_ConfigGetLogical(config, label, value, kwe, &
    isPresent, defaultValue, rc)

    type(ESMF_Config), intent(inout)       :: config
    character(len=*), intent(in)           :: label
    logical, intent(inout)                 :: value
    type(ESMF_KeywordEnforcer), optional   :: kwe
    logical, optional                      :: isPresent
    logical, intent(in), optional          :: defaultValue
    integer(ESMF_KIND_I4), intent(out), optional :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: message

    rc_ = ESMF_SUCCESS
    if (present(kwe)) localrc = ESMF_SUCCESS

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(defaultValue)) then
        value=defaultValue
        if (present(rc)) rc = ESMF_SUCCESS
      else
        if (present(rc)) rc = ESMF_RC_NOT_FOUND
      endif
      return
    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetAttribute(config, value=value, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    write(message,'(A)') '-- item '//trim(label)//':'
    write(message,'(A,L)') trim(message)//' ', value
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetLogical

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetInt4"
  subroutine MOSSCO_ConfigGetInt4(config, label, value, kwe, &
    isPresent, defaultValue, rc)

    type(ESMF_Config), intent(inout)       :: config
    character(len=*), intent(in)           :: label
    integer(ESMF_KIND_I4), intent(inout)   :: value
    type(ESMF_KeywordEnforcer), intent(in), optional :: kwe
    logical, optional, intent(out)         :: isPresent
    integer(ESMF_KIND_I4), intent(in), optional      :: defaultValue
    integer(ESMF_KIND_I4), intent(out), optional     :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: message

    rc_ = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS
    if (present(rc)) rc = rc_

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', &
      isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_
    if (.not.isPresent_) then
      if (present(defaultValue)) then
        value=defaultValue
      else
        if (present(rc)) rc = ESMF_RC_NOT_FOUND
      endif
      return
    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetAttribute(config, value=value, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    write(message,'(A)') '-- item '//trim(label)//':'
    write(message,'(A,I5)') trim(message)//' ', value
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetInt4

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetInt8"
  subroutine MOSSCO_ConfigGetInt8(config, label, value, kwe, &
    isPresent, defaultValue, rc)

    type(ESMF_Config), intent(inout)       :: config
    character(len=*), intent(in)           :: label
    integer(ESMF_KIND_I8), intent(inout)   :: value
    type(ESMF_KeywordEnforcer), intent(in), optional :: kwe
    logical, optional, intent(out)         :: isPresent
    integer(ESMF_KIND_I8), intent(in), optional      :: defaultValue
    integer(ESMF_KIND_I4), intent(out), optional     :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: message

    rc_ = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_
    if (.not.isPresent_) then
      if (present(defaultValue)) then
        value=defaultValue
      else
        if (present(rc)) rc = ESMF_RC_NOT_FOUND
      endif
      return
    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetAttribute(config, value=value, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    write(message,'(A)') '-- item '//trim(label)//':'
    write(message,'(A,I9)') trim(message)//' ', value
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetInt8

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetString"
  subroutine MOSSCO_ConfigGetString(config, label, value, kwe, &
    defaultValue, isPresent, rc)

    type(ESMF_Config), intent(inout)             :: config
    character(len=*), intent(in)                 :: label
    character(len=*), intent(inout)              :: value
    type(ESMF_KeywordEnforcer), optional         :: kwe
    logical, optional, intent(out)               :: isPresent
    character(len=*), intent(in), optional       :: defaultValue
    integer(ESMF_KIND_I4), intent(out), optional :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: message

    rc_ = ESMF_SUCCESS
    if (present(kwe)) localrc = ESMF_SUCCESS

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(defaultValue)) then
        value=trim(defaultValue)
        if (present(rc)) rc = ESMF_SUCCESS
      else
        if (present(rc)) rc = ESMF_RC_NOT_FOUND
      endif
      return
    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetAttribute(config, value=value, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    write(message,'(A)') '-- item '//trim(label)//': '//trim(value)
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetString

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetReal4"
  subroutine MOSSCO_ConfigGetReal4(config, label, value, kwe, &
    isPresent, defaultValue, rc)

    type(ESMF_Config), intent(inout)       :: config
    character(len=*), intent(in)           :: label
    real(ESMF_KIND_R4), intent(inout)      :: value
    type(ESMF_KeywordEnforcer), intent(in), optional :: kwe
    logical, optional, intent(out)                :: isPresent
    real(ESMF_KIND_R4), intent(in), optional      :: defaultValue
    integer(ESMF_KIND_I4), intent(out), optional  :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: message

    rc_ = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(defaultValue)) then
        value=defaultValue
      else
        if (present(rc)) rc = ESMF_RC_NOT_FOUND
      endif
      return
    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetAttribute(config, value=value, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    write(message,'(A)') '-- item '//trim(label)//':'
    write(message,'(A,ES10.3)') trim(message)//' ', value
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetReal4

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetReal8"
  subroutine MOSSCO_ConfigGetReal8(config, label, value, kwe, &
    isPresent, defaultValue, rc)

    type(ESMF_Config), intent(inout)       :: config
    character(len=*), intent(in)           :: label
    real(ESMF_KIND_R8), intent(inout)   :: value
    type(ESMF_KeywordEnforcer), intent(in), optional :: kwe
    logical, optional, intent(out)                :: isPresent
    real(ESMF_KIND_R8), intent(in), optional      :: defaultValue
    integer(ESMF_KIND_I4), intent(out), optional  :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: message

    rc_ = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(defaultValue)) then
        value=defaultValue
      else
        if (present(rc)) rc = ESMF_RC_NOT_FOUND
      endif
      return
    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetAttribute(config, value=value, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    write(message,'(A)') '-- item '//trim(label)//':'
    write(message,'(A,ES10.3)') trim(message)//' ', value
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetReal8

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetListInt4"
  subroutine MOSSCO_ConfigGetListInt4(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)                  :: config
    character(len=*), intent(in)                      :: label
    integer(ESMF_KIND_I4), intent(inout), allocatable :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: string

    rc_ = ESMF_SUCCESS

    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    n = ESMF_ConfigGetLen(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (n < 1) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    if (allocated(value)) deallocate(value)
    allocate(value(n), stat=localrc)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i=1, n
      call ESMF_ConfigGetAttribute(config, value=string, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      read(string, *, iostat=localrc) value(i)
      !> @todo check return code
    enddo

    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetListInt4

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetListReal4"
  subroutine MOSSCO_ConfigGetListReal4(config, label, value, kwe, &
    isPresent, rc)

    type(ESMF_Config), intent(inout)                  :: config
    character(len=*), intent(in)                      :: label
    real(ESMF_KIND_R4), intent(inout), allocatable    :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: string

    rc_ = ESMF_SUCCESS

    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_
    if (.not.isPresent_) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    n = ESMF_ConfigGetLen(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (n < 1) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    if (allocated(value)) deallocate(value)
    allocate(value(n), stat=localrc)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i=1, n
      call ESMF_ConfigGetAttribute(config, value=string, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      read(string, *, iostat=localrc) value(i)
      !> @todo check return code
    enddo

    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetListReal4

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetListReal8"
  subroutine MOSSCO_ConfigGetListReal8(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)                  :: config
    character(len=*), intent(in)                      :: label
    real(ESMF_KIND_R8), intent(inout), allocatable    :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: string

    rc_ = ESMF_SUCCESS

    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    n = ESMF_ConfigGetLen(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (n < 1) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    if (allocated(value)) deallocate(value)
    allocate(value(n), stat=localrc)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i=1, n
      call ESMF_ConfigGetAttribute(config, value=string, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      read(string, *, iostat=localrc) value(i)
      !> @todo check return code
    enddo

    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetListReal8

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetListInt8"
  subroutine MOSSCO_ConfigGetListInt8(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)                  :: config
    character(len=*), intent(in)                      :: label
    integer(ESMF_KIND_I8), intent(inout), allocatable :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_
    character(len=ESMF_MAXSTR)           :: string

    rc_ = ESMF_SUCCESS

    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    n = ESMF_ConfigGetLen(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (n < 1) then
      if (present(rc)) rc = ESMF_SUCCESS
      return
    endif

    if (allocated(value)) deallocate(value)
    allocate(value(n), stat=localrc)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i=1, n
      call ESMF_ConfigGetAttribute(config, value=string, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      read(string, *, iostat=localrc) value(i)
      !> @todo check return code
    enddo

    if (present(rc)) rc = rc_

  end subroutine MOSSCO_ConfigGetListInt8

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringList"
  subroutine MOSSCO_ConfigGetStringList(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)  :: label
    character(len=VARLEN), intent(inout), allocatable :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_

    if (present(rc)) rc = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS

    if (allocated(value)) deallocate(value)

    !> Test whether to read a Table
    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', &
      isPresent=isPresent_, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (isPresent_) then
      call MOSSCO_ConfigGetStringListTable(config, label, value, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)
      return

    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (isPresent_) then
      call MOSSCO_ConfigGetStringListList(config, label, value, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      return
    endif

  end subroutine MOSSCO_ConfigGetStringList

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringListPtr"
  subroutine MOSSCO_ConfigGetStringListPtr(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)  :: label
    character(len=VARLEN), intent(inout), pointer :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_

    if (present(rc)) rc = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS

    if (associated(value)) deallocate(value)

    !> Test whether to read a Table
    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', &
      isPresent=isPresent_, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (isPresent_) then
      call MOSSCO_ConfigGetStringListPtrTable(config, label, value, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)
      return

    endif

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (isPresent_) then
      call MOSSCO_ConfigGetStringListPtrList(config, label, value, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      return
    endif

  end subroutine MOSSCO_ConfigGetStringListPtr

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringListTable"
  subroutine MOSSCO_ConfigGetStringListTable(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)  :: label
    character(len=VARLEN), intent(inout), allocatable :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, j
    integer(ESMF_KIND_I4)                :: rowCount, columnCount
    logical                              :: isPresent_, isTableEnd
    character(len=ESMF_MAXSTR)           :: message

    if (present(rc)) rc = ESMF_SUCCESS
    if (allocated(value)) deallocate(value)

    if (present(rc)) rc=ESMF_SUCCESS
    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) return

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetDim(config, label=trim(label)//'::', &
      lineCount=rowCount, columnCount=columnCount, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (rowCount * columnCount < 1) return
    if (columnCount /= 1) return

    !write(message,'(A,I1,A,I1,A)') '  reading table "'//trim(label)//'::" (',rowCount,' x ', columnCount,')'
    write(message,'(A,I1,A,I1,A)') '  reading table "'//trim(label)//'"'
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    allocate(value(rowCount), stat=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i = 1, rowCount
      call ESMF_ConfigNextLine(config, tableEnd=isTableEnd, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      if (isTableEnd) exit

      call ESMF_ConfigGetAttribute(config, value(i), rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      write(message, '(A)') '  '//trim(value(i))
      call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    enddo

    if (present(rc)) rc = localrc

  end subroutine MOSSCO_ConfigGetStringListTable

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringListPtrTable"
  subroutine MOSSCO_ConfigGetStringListPtrTable(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)  :: label
    character(len=VARLEN), intent(inout), pointer :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, j
    integer(ESMF_KIND_I4)                :: rowCount, columnCount
    logical                              :: isPresent_, isTableEnd
    character(len=ESMF_MAXSTR)           :: message

    if (present(rc)) rc = ESMF_SUCCESS
    if (associated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) return

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetDim(config, label=trim(label)//'::', &
      lineCount=rowCount, columnCount=columnCount, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (rowCount * columnCount < 1) return
    if (columnCount /= 1) return

    !write(message,'(A,I1,A,I1,A)') '  reading table "'//trim(label)//'::" (',rowCount,' x ', columnCount,')'
    write(message,'(A,I1,A,I1,A)') '  reading table "'//trim(label)//'"'
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    allocate(value(rowCount), stat=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i = 1, rowCount
      call ESMF_ConfigNextLine(config, tableEnd=isTableEnd, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      if (isTableEnd) exit

      call ESMF_ConfigGetAttribute(config, value(i), rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      write(message, '(A)') '  '//trim(value(i))
      call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    enddo

    if (present(rc)) rc = localrc

  end subroutine MOSSCO_ConfigGetStringListPtrTable

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringListList"
  subroutine MOSSCO_ConfigGetStringListList(config, label, value, kwe, &
    isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)  :: label
    character(len=VARLEN), intent(inout), allocatable :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_

    if (present(rc)) rc = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS

    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', &
      isPresent=isPresent_, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) return

    n=ESMF_ConfigGetLen(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (n<=0) return
    allocate(value(n))

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i=1, n
      call ESMF_ConfigGetAttribute(config, value=value(i), rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)
    enddo

  end subroutine MOSSCO_ConfigGetStringListList

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringListPtrList"
  subroutine MOSSCO_ConfigGetStringListPtrList(config, label, value, kwe, &
    isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)  :: label
    character(len=VARLEN), intent(inout), pointer :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, n
    logical                              :: isPresent_

    if (present(rc)) rc = ESMF_SUCCESS
    if (present(kwe)) rc_ = ESMF_SUCCESS

    if (associated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', &
      isPresent=isPresent_, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) return

    n=ESMF_ConfigGetLen(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (n<=0) return
    allocate(value(n))

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i=1, n
      call ESMF_ConfigGetAttribute(config, value=value(i), rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)
    enddo

  end subroutine MOSSCO_ConfigGetStringListPtrList

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringTableKeyValue"
  subroutine MOSSCO_ConfigGetStringTableKeyValue(config, label, value, kwe, &
    isPresent, sep, rc)

    type(ESMF_Config), intent(inout)                       :: config
    character(len=*), intent(in)                           :: label
    character(len=VARLEN), intent(inout), allocatable :: value(:,:)
    type(ESMF_KeywordEnforcer), optional                   :: kwe
    logical, optional                                      :: isPresent
    character(len=*), intent(in), optional                 :: sep
    integer(ESMF_KIND_I4), intent(inout), optional         :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, j, n
    logical                              :: isPresent_
    character(ESMF_MAXSTR)               :: currString, message
    character(len=1)                     :: sep_

    if (present(rc)) rc = ESMF_SUCCESS
    if (present(kwe)) localrc = ESMF_SUCCESS
    if (present(sep)) sep_ = sep(1:1)

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_
    if (.not.isPresent_) return

    n=ESMF_ConfigGetLen(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (n < 1) return

    write(message,'(A,I1,A,I1,A)') '  reading key'//sep_//'value list "'//trim(label)//':" (',n,')'
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    if (allocated(value)) deallocate(value)
    allocate(value(n, 2), stat=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    value(:,:) = ' '

    call ESMF_ConfigFindLabel(config, label=trim(label)//':', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i=1, n
      call ESMF_ConfigGetAttribute(config, value=currString, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      j=index(currString,sep_)
      if (j>1) then
         value(i,1)=currString(1:j-1)
         value(i,2)=currString(j+1:len_trim(currString))
      endif
      write(message,'(A)') '  '//trim(value(i,1))
      call MOSSCO_MessageAdd(message, ' '//sep_)
      call MOSSCO_MessageAdd(message, ' '//trim(value(i,2)))
      call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    enddo

  end subroutine MOSSCO_ConfigGetStringTableKeyValue

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringTableTable"
!> Obtains a two-dimensional list of strings obtained from a Table in
!> ESMF_Config format
  subroutine MOSSCO_ConfigGetStringTableTable(config, label, value, &
    kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)   :: label
    character(len=ESMF_MAXSTR), intent(out), allocatable :: value(:,:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, j
    integer(ESMF_KIND_I4)                :: rowCount, columnCount
    logical                              :: isPresent_, isTableEnd
    character(len=ESMF_MAXSTR)           :: message

    if (present(rc)) rc=ESMF_SUCCESS
    if (present(kwe)) rc_=ESMF_SUCCESS
    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', &
      isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_
    if (.not.isPresent_) return

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetDim(config, label=trim(label)//'::', &
      lineCount=rowCount, columnCount=columnCount, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    write(message,'(A,I1,A,I1,A)') '  reading table "'//trim(label)//'::" (',rowCount,' x ', columnCount,')'
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    if (allocated(value)) deallocate(value)
    allocate(value(rowCount,columnCount), stat=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    do i = 1, rowCount
      call ESMF_ConfigNextLine(config, tableEnd=isTableEnd, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      if (isTableEnd) exit

      do j = 1, columnCount

        ! Attempt to read the jth item, this can fail if it has
        ! been omitted by the user, then the default empty string is
        ! written to the table
        call ESMF_ConfigGetAttribute(config, value(i,j), rc=localrc)
        if (localrc == ESMF_RC_NOT_FOUND) then
          value(i,j) = ''
          localrc = ESMF_SUCCESS
          cycle
        endif

        _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

        if (j == 1) then
          write(message, '(A)') '  '//trim(value(i,j))
        else
          call MOSSCO_MessageAdd(message, ' '//trim(value(i,j)))
        endif
      enddo
      call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    enddo

    if (present(rc)) rc=localrc

  end subroutine MOSSCO_ConfigGetStringTableTable

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringTable"
!> Obtains a two-dimensional list of strings obtained from a Table in
!> ESMF_Config format or a key/value list
  subroutine MOSSCO_ConfigGetStringTable(config, label, value, kwe, &
    isPresent, sep, rc)

    type(ESMF_Config), intent(inout)                       :: config
    character(len=*), intent(in)                           :: label
    character(len=VARLEN), intent(inout), allocatable :: value(:,:)
    logical, optional                                      :: isPresent
    type(ESMF_KeywordEnforcer), optional                   :: kwe
    character(len=*), intent(in), optional                 :: sep
    integer(ESMF_KIND_I4), intent(inout), optional :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_
    logical                              :: isPresent_
    character(len=1)                     :: sep_

    if (present(rc))  rc=ESMF_SUCCESS
    if (present(kwe)) localrc = ESMF_SUCCESS
    sep_ = '='
    if (present(sep)) sep_ = sep(1:1)
    if (allocated(value)) deallocate(value)

    ! First check for table
    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (isPresent_) then
      call MOSSCO_ConfigGetStringTableTable(config, label=trim(label), value=value, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      if (present(rc)) rc = localrc
      return
    endif

    ! Alternatively check for list
    call ESMF_ConfigFindLabel(config, label=trim(label)//':', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_

    if (isPresent_) then
      call MOSSCO_ConfigGetStringTableKeyValue(config, label=trim(label), &
        value=value, sep=sep_, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    endif
    if (present(rc)) rc = localrc

  end subroutine MOSSCO_ConfigGetStringTable

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetStringListTable1"
!> Obtains a one-dimensional list of strings obtained from a Table in
!> ESMF_Config format
  subroutine MOSSCO_ConfigGetStringListTable1(config, label, value, kwe, isPresent, rc)

    type(ESMF_Config), intent(inout)  :: config
    character(len=*), intent(in)   :: label
    character(len=ESMF_MAXSTR), intent(out), allocatable :: value(:)
    type(ESMF_KeywordEnforcer), optional, intent(in)  :: kwe
    logical, optional, intent(out)              :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional      :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, rowCount, columnCount
    logical                              :: isPresent_, isTableEnd
    character(len=ESMF_MAXSTR)           :: message

    if (present(rc)) rc=ESMF_SUCCESS
    if (allocated(value)) deallocate(value)

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', isPresent=isPresent_, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (present(isPresent)) isPresent=isPresent_
    if (.not.isPresent_) return

    call ESMF_ConfigFindLabel(config, label=trim(label)//'::', rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    call ESMF_ConfigGetDim(config, label=trim(label)//'::', &
      lineCount=rowCount, columnCount=columnCount, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    if (rowCount * columnCount < 1) return

    if (columnCount /= 1) then
      if (present(rc)) rc = ESMF_RC_ARG_BAD
      return
    endif

    write(message,'(A,I1,A,I1,A)') '  reading table "'//trim(label)//'::" (',rowCount,' x ', columnCount,')'
    call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)

    if (allocated(value)) deallocate(value)
    allocate(value(rowCount), stat=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    value(:) = ' '

    do i = 1, rowCount
      call ESMF_ConfigNextLine(config, tableEnd=isTableEnd, rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      if (isTableEnd) exit

      call ESMF_ConfigGetAttribute(config, value(i), rc=localrc)
      _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

      call MOSSCO_MessageAdd(message, '  '//trim(value(i)))
      call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    enddo

    if (present(rc)) rc=localrc

  end subroutine MOSSCO_ConfigGetStringListTable1

#undef  ESMF_METHOD
#define ESMF_METHOD "MOSSCO_ConfigGetFileStringTable"
!> Obtains a two-dimensional list of strings obtained from a Table in
!> ESMF_Config format, but without ESMF_Config routines (workaround)
  subroutine MOSSCO_ConfigGetFileStringTable(fileName, label, value, &
    kwe, isPresent, rc)

    character(len=*), intent(in)   :: fileName
    character(len=*), intent(in)   :: label
    character(len=VARLEN), intent(inout), allocatable :: value(:,:)
    type(ESMF_KeywordEnforcer), intent(in), optional   :: kwe
    logical, intent(out), optional                     :: isPresent
    integer(ESMF_KIND_I4), intent(out), optional       :: rc

    integer(ESMF_KIND_I4)                :: localrc, rc_, i, j, rowCount, columnCount
    integer(ESMF_KIND_I4)                :: lun, bufferSize = 10
    logical                              :: isPresent_, isTableEnd
    character(len=ESMF_MAXSTR)           :: message, string
    character(len=ESMF_MAXSTR), allocatable :: stringList(:), tempList(:)

    if (present(rc)) rc=ESMF_SUCCESS
    if (allocated(value)) deallocate(value)

    call ESMF_UtilIOUnitGet(lun, rc=localrc)
    _MOSSCO_LOG_AND_FINALIZE_ON_ERROR_(rc_)

    open (unit=lun, file=trim(fileName), status='old',    &
       access='sequential', form='formatted', action='read' )

    rowCount = 0
    columnCount = 2
    localrc = ESMF_SUCCESS

    ! Find the label in the file
    do while (localrc == ESMF_SUCCESS)
      read (lun, *, iostat=localrc) string
      if (localrc /= ESMF_SUCCESS) exit

      i = index(string, trim(label)//'::')
      if (i < 1) cycle
      call ESMF_LogWrite('-- item '//trim(string), ESMF_LOGMSG_INFO)
      isPresent_ = .true.
      exit
    enddo

    if (present(isPresent)) isPresent=isPresent_

    if (.not.isPresent_) then
      if (present(rc)) rc = ESMF_RC_NOT_FOUND
      return
    endif

    ! Read into a string Buffer
    ! call MOSSCO_Reallocate(stringList, bufferSize, keep=.false., rc=localrc)
    if (allocated(stringList)) deallocate(stringList, stat=localrc)
    allocate(stringList(bufferSize), stat=localrc)

    rowCount = 0
    do while (localrc == ESMF_SUCCESS)
      read (lun, *, iostat=localrc) string
      if (localrc /= ESMF_SUCCESS) exit

      i = index(string, '::')
      if (i > 0) exit
      rowCount = rowCount + 1

      if (rowCount > bufferSize) then

        if (allocated(tempList)) deallocate(tempList, stat=localrc)
        allocate(tempList(bufferSize), stat=localrc)

        tempList(1:bufferSize) = stringList(1:bufferSize)

        if (allocated(stringList)) deallocate(stringList, stat=localrc)
        allocate(stringList(2*bufferSize), stat=localrc)

        stringList(1:bufferSize) = tempList(1:bufferSize)
        bufferSize = 2 * bufferSize

        !call MOSSCO_Reallocate(stringList, buffersize, keep=.true., rc=localrc)
      endif

      stringList(rowCount) = trim(string)
      write(message,'(A,I2,A)') '-- item ',rowCount,' '//trim(stringList(rowCount))
      call ESMF_LogWrite(trim(message), ESMF_LOGMSG_INFO)
    enddo

    if (rowCount < 0) then
      if (present(rc)) rc = ESMF_RC_NOT_FOUND
      return
    endif

    allocate(value(rowCount,columnCount))

    if (rowCount * columnCount < 1) then
      if (present(rc)) rc = ESMF_RC_NOT_FOUND
      return
    endif

    if (columnCount /= 2) then
      if (present(rc)) rc = ESMF_RC_ARG_BAD
      return
    endif

    do i = 1, rowCount
      string = stringList(i)
      j = index(string,' ')
      value(i,1) = string(1:j-1)
      value(i,2) = trim(adjustl(string(1:j-1)))
    enddo

    if (present(rc)) rc=localrc

  end subroutine MOSSCO_ConfigGetFileStringTable

end module mossco_config
